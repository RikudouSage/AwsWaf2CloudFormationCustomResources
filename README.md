# Custom WAF2 (Web Application Firewall) resources for CloudFormation

Useful when you need to create a WebACL in `us-east-1` but the rest of your app is in different region.

## Installation

You need `serverless` framework.

1. Clone this repository
2. Run `yarn install` (or use `npm` if that's more your thing)
3. Run `serverlesss deploy` (will deploy with stage name `dev`)
   1. Alternatively specify a stage, like `serverless deploy --stage prod`
   2. You can also specify a region: `serverless deploy --stage prod --region eu-central-1`
4. **Repeat for all regions you intend to use the custom resources in**

## Usage

The custom resources closely mimic the official AWS resources, so consult the 
[official documentation](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_WAFv2.html).

The differences are:

- Using `Ref` function returns ARN, not `name|id|scope`
- If any rule doesn't have a name, it will be autogenerated

Note that not everything has been extensively tested, so there may be bugs coming from the fact that AWS does kind of
a naming conventions freestyle depending on what part of their infrastructure you're dealing with 
(like `Arn` in `CloudFormation` but `ARN` in libraries).

Example:
```yaml
service: MyCoolService
custom:
  # change the 'prod' in 'WafCustomResources-prod-customResources' if you deployed to a different stage
  ServiceToken: !Join [':', ['arn:aws:lambda', !Ref AWS::Region, !Ref AWS::AccountId, 'function:WafCustomResources-prod-customResources']]

resources:
  Resources:
    MyIpSet:
      Type: Custom::WAFv2IPSet
      Properties:
        ServiceToken: ${self:custom.ServiceToken} # reference the custom resources lambda
        Addresses:
          - 127.0.0.1/32
        IPAddressVersion: IPV4
        Scope: CLOUDFRONT
    WebAcl:
      Type: Custom::WAFv2WebACL
      Properties:
        ServiceToken: ${self:custom.ServiceToken} # reference the custom resources lambda
        CustomResponseBodies:
          deny403:
            Content: '{"error":"Not allowed"}'
            ContentType: APPLICATION_JSON
        DefaultAction:
          Block:
            CustomResponse:
              CustomResponseBodyKey: deny403
              ResponseCode: 403
        Description: Test
        Rules:
          - Action:
              Allow: {}
            Priority: 0
            Statement:
              IPSetReferenceStatement:
                Arn: !GetAtt IpSet.Arn
            VisibilityConfig:
              CloudWatchMetricsEnabled: true
              MetricName: AllowedUiAccess
              SampledRequestsEnabled: true
        Scope: CLOUDFRONT
        Tags:
          - Key: TestTag2
            Value: TestValue2
        VisibilityConfig:
          CloudWatchMetricsEnabled: true
          MetricName: BlockedUiAccess
          SampledRequestsEnabled: true
```
